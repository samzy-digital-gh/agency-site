<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Code Fall Â· Samzy Community</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* === DESIGN SYSTEM (same as other pages) === */
        :root {
            --primary: #0052CC;
            --accent: #FF6B35;
            --neutral-50: #F8FAFC;
            --neutral-200: #E2E8F0;
            --neutral-400: #94A3B8;
            --neutral-600: #64748B;
            --neutral-900: #1E293B;
            --white: #FFFFFF;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.03);
            --shadow-md: 0 6px 18px rgba(0,0,0,0.05);
            --radius-card: 16px;
            --radius-button: 40px;
            --space-1: 8px;
            --space-2: 16px;
            --space-3: 24px;
            --space-4: 32px;
            --space-5: 40px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        body {
            background: #0f172a;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 1.2rem;
            padding: 10px 15px;
            border-radius: 40px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            z-index: 10;
            text-decoration: none;
        }
        .back-btn i {
            margin-right: 5px;
        }
        .game-container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1e293b;
            padding: 15px 20px;
            border-radius: 60px;
        }
        .lives {
            display: flex;
            gap: 5px;
            font-size: 1.5rem;
        }
        .lives i {
            color: #EF4444;
        }
        .score {
            font-size: 1.2rem;
            font-weight: 600;
            background: var(--primary);
            padding: 8px 20px;
            border-radius: 40px;
        }
        .canvas-wrapper {
            background: #1e293b;
            border-radius: 24px;
            padding: 10px;
        }
        canvas {
            display: block;
            width: 100%;
            height: auto;
            background: #0f172a;
            border-radius: 16px;
            cursor: text;
            touch-action: none; /* prevent scrolling while tapping on canvas */
        }
        .input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .input-area input {
            flex: 1;
            background: #1e293b;
            border: 1px solid var(--neutral-200);
            color: white;
            padding: 15px 20px;
            border-radius: 60px;
            font-size: 1.2rem;
            outline: none;
        }
        .input-area input:focus {
            border-color: var(--primary);
        }
        .input-area button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 60px;
            font-size: 1.2rem;
            cursor: pointer;
            font-weight: 600;
        }
        .input-area button:hover {
            background: #e05530;
        }
        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        .game-over-content {
            background: #1e293b;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 400px;
        }
        .game-over-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: var(--accent);
        }
        .game-over-content p {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        .game-over-content button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 40px;
            font-size: 1rem;
            cursor: pointer;
        }
        .game-over-content button:hover {
            background: #003d99;
        }
        @media (max-width:600px) {
            .stats { flex-direction: column; gap: 10px; }
            .input-area { flex-direction: column; }
            .input-area button { width: 100%; }
        }
    </style>
</head>
<body>
    <a href="blog-games.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
    <div class="game-container">
        <div class="stats">
            <div class="lives" id="livesDisplay">
                <i class="fas fa-heart"></i>
                <i class="fas fa-heart"></i>
                <i class="fas fa-heart"></i>
            </div>
            <div class="score">Score: <span id="score">0</span></div>
        </div>
        <div class="canvas-wrapper">
            <canvas id="gameCanvas" width="600" height="400"></canvas>
        </div>
        <div class="input-area">
            <input type="text" id="wordInput" placeholder="Type word..." autocomplete="off" disabled>
            <button id="clearBtn">Clear</button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="game-over" id="gameOverModal">
        <div class="game-over-content">
            <h2>Game Over</h2>
            <p>Your score: <span id="finalScore">0</span></p>
            <button id="playAgainBtn">Play Again</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBkgwVFe1PMYMvmZxoFVFErZ27Q3XYQ-_g",
            authDomain: "samzy-community-blog.firebaseapp.com",
            projectId: "samzy-community-blog",
            storageBucket: "samzy-community-blog.firebasestorage.app",
            messagingSenderId: "573240466296",
            appId: "1:573240466296:web:5faa312a1136162961468d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ---------- Game Variables ----------
        let currentUser = null;
        let canvas, ctx;
        let gameActive = false;
        let animationFrame;
        let words = [];
        let lives = 3;
        let score = 0;
        let baseSpeed = 0.8;
        let spawnInterval = 2000; // ms
        let lastSpawn = 0;
        let highScore = 0; // user's previous high score (typingPoints)

        // Word list (150+ coding terms)
        const wordList = [
            'html', 'css', 'js', 'react', 'vue', 'angular', 'node', 'express',
            'mongodb', 'firebase', 'sql', 'python', 'java', 'c++', 'c#', 'php',
            'ruby', 'swift', 'kotlin', 'go', 'rust', 'typescript', 'javascript',
            'function', 'const', 'let', 'var', 'if', 'else', 'for', 'while',
            'switch', 'case', 'break', 'continue', 'return', 'class', 'extends',
            'this', 'super', 'new', 'delete', 'try', 'catch', 'finally', 'throw',
            'import', 'export', 'default', 'from', 'as', 'async', 'await',
            'promise', 'then', 'catch', 'finally', 'array', 'object', 'string',
            'number', 'boolean', 'null', 'undefined', 'map', 'filter', 'reduce',
            'forEach', 'push', 'pop', 'shift', 'unshift', 'splice', 'slice',
            'concat', 'join', 'split', 'indexof', 'includes', 'find', 'some',
            'every', 'sort', 'reverse', 'keys', 'values', 'entries', 'assign',
            'freeze', 'seal', 'prototype', 'constructor', 'instanceof', 'typeof',
            'void', 'debugger', 'with', 'yield', 'enum', 'implements', 'interface',
            'package', 'private', 'protected', 'public', 'static', 'abstract',
            'boolean', 'byte', 'char', 'double', 'final', 'float', 'goto', 'int',
            'long', 'native', 'short', 'synchronized', 'transient', 'volatile',
            'div', 'span', 'a', 'href', 'src', 'alt', 'title', 'class', 'id',
            'style', 'rel', 'type', 'media', 'script', 'link', 'meta', 'head',
            'body', 'header', 'footer', 'nav', 'main', 'section', 'article',
            'aside', 'figure', 'figcaption', 'p', 'br', 'hr', 'pre', 'code',
            'em', 'strong', 'small', 'mark', 'del', 'ins', 'sub', 'sup',
            'blockquote', 'q', 'cite', 'dfn', 'abbr', 'time', 'address', 'bdo',
            'button', 'input', 'textarea', 'select', 'option', 'label', 'fieldset',
            'legend', 'form', 'method', 'action', 'enctype', 'accept', 'name',
            'value', 'checked', 'selected', 'disabled', 'readonly', 'placeholder'
        ];

        // ---------- Helper Functions ----------
        function getRandomWord() {
            return wordList[Math.floor(Math.random() * wordList.length)];
        }

        function updateLivesDisplay() {
            const container = document.getElementById('livesDisplay');
            container.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                if (i < lives) {
                    container.innerHTML += '<i class="fas fa-heart"></i>';
                } else {
                    container.innerHTML += '<i class="far fa-heart"></i>';
                }
            }
        }

        // ---------- Game Loop ----------
        function spawnWord() {
            if (!gameActive) return;
            const x = Math.random() * (canvas.width - 100) + 50;
            words.push({
                text: getRandomWord(),
                x: x,
                y: 20,
                speed: baseSpeed + (score * 0.01) // speed increases with score
            });
        }

        function updateWords() {
            if (!gameActive) return;
            for (let i = words.length - 1; i >= 0; i--) {
                const w = words[i];
                w.y += w.speed;
                // Check if word reached bottom
                if (w.y > canvas.height - 30) {
                    words.splice(i, 1);
                    lives--;
                    if (lives <= 0) {
                        gameActive = false;
                        cancelAnimationFrame(animationFrame);
                        gameOver();
                    }
                    updateLivesDisplay();
                }
            }
        }

        function drawWords() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = 'bold 20px "Courier New", monospace';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            words.forEach(w => {
                // color based on first letter hash
                const hue = (w.text.charCodeAt(0) * 10) % 360;
                ctx.fillStyle = `hsl(${hue}, 80%, 60%)`;
                ctx.fillText(w.text, w.x, w.y);
            });
        }

        function gameLoop() {
            if (!gameActive) return;
            updateWords();
            drawWords();
            animationFrame = requestAnimationFrame(gameLoop);
        }

        // ---------- Spawn Interval ----------
        function startSpawnTimer() {
            setInterval(() => {
                if (gameActive) {
                    spawnWord();
                }
            }, spawnInterval);
        }

        // ---------- Game Over ----------
        function gameOver() {
            gameActive = false;
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOverModal').style.display = 'flex';
            // Save high score
            if (currentUser && score > highScore) {
                saveHighScore(score);
            }
        }

        async function saveHighScore(newScore) {
            const userRef = db.collection('users').doc(currentUser.uid);
            await db.runTransaction(async (transaction) => {
                const userDoc = await transaction.get(userRef);
                const current = userDoc.data().typingPoints || 0;
                if (newScore > current) {
                    transaction.update(userRef, {
                        typingPoints: newScore,
                        points: firebase.firestore.FieldValue.increment(newScore - current)
                    });
                    console.log('New high score saved!');
                }
            }).catch(e => console.error('Transaction error:', e));
        }

        // ---------- Start New Game ----------
        function startNewGame() {
            lives = 3;
            score = 0;
            words = [];
            gameActive = true;
            document.getElementById('score').textContent = '0';
            updateLivesDisplay();
            document.getElementById('gameOverModal').style.display = 'none';
            document.getElementById('wordInput').disabled = false;
            document.getElementById('wordInput').focus();
            lastSpawn = Date.now();
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Start loop
            if (animationFrame) cancelAnimationFrame(animationFrame);
            animationFrame = requestAnimationFrame(gameLoop);
        }

        // ---------- Input Handling ----------
        document.getElementById('wordInput').addEventListener('input', (e) => {
            if (!gameActive) return;
            const typed = e.target.value.trim().toLowerCase();
            if (typed === '') return;

            // Find word that matches exactly
            const index = words.findIndex(w => w.text === typed);
            if (index !== -1) {
                // Remove word
                words.splice(index, 1);
                score++;
                document.getElementById('score').textContent = score;
                e.target.value = ''; // clear input
            }
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('wordInput').value = '';
            document.getElementById('wordInput').focus();
        });

        // ---------- Authentication ----------
        auth.onAuthStateChanged(async user => {
            if (!user) {
                const returnTo = encodeURIComponent(window.location.href);
                window.location.href = `login.html?returnTo=${returnTo}`;
                return;
            }
            currentUser = user;
            // Load user's high score (typingPoints)
            const doc = await db.collection('users').doc(user.uid).get();
            if (doc.exists) {
                highScore = doc.data().typingPoints || 0;
            }
            // Initialize canvas and start game
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            // Adjust canvas size based on container
            function resizeCanvas() {
                const wrapper = document.querySelector('.canvas-wrapper');
                const containerWidth = wrapper.clientWidth - 20; // padding
                canvas.width = containerWidth;
                canvas.height = containerWidth * 0.6; // aspect ratio 5:3
                // redraw if game active
                if (gameActive) drawWords();
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            startNewGame();
            startSpawnTimer();
        });

        // Play again button
        document.getElementById('playAgainBtn').addEventListener('click', startNewGame);
    </script>
</body>
</html>