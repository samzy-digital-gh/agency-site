<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home · Samzy Community</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ========== GLOBAL STYLES (same as before) ========== */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
        body { background:#f8fafc; color:#1e293b; }
        a { text-decoration:none; color:inherit; }
        .blog-header {
            background:white; position:sticky; top:0; z-index:50;
            box-shadow:0 2px 10px rgba(0,0,0,0.03);
            border-bottom:1px solid rgba(0,102,255,0.1);
        }
        .header-container {
            max-width:1300px; margin:0 auto; padding:1rem 2rem;
            display:flex; align-items:center; justify-content:space-between;
        }
        .logo { font-size:1.5rem; font-weight:600; }
        .logo i { color:#0066FF; margin-right:6px; }
        .logo span { color:#FF6B35; }
        .nav-links { display:flex; gap:2rem; }
        .nav-links a { font-weight:500; padding:0.5rem 0; border-bottom:2px solid transparent; transition:0.2s; }
        .nav-links a:hover, .nav-links a.active { color:#0066FF; border-bottom-color:#0066FF; }
        .user-menu { position:relative; }
        .user-avatar {
            width:40px; height:40px; border-radius:50%; background:#e6f0ff; color:#0066FF;
            display:flex; align-items:center; justify-content:center; font-weight:600; cursor:pointer;
        }
        .user-avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
        .dropdown {
            position:absolute; right:0; top:50px; background:white; border-radius:16px;
            box-shadow:0 10px 30px rgba(0,0,0,0.1); width:180px; display:none; z-index:100;
            border:1px solid #eef2f6;
        }
        .dropdown.show { display:block; }
        .dropdown a { display:flex; align-items:center; gap:10px; padding:0.9rem 1.2rem; transition:background 0.2s; }
        .dropdown a:hover { background:#f1f5f9; }
        .dropdown i { width:20px; color:#0066FF; }

        /* ========== MAIN LAYOUT ========== */
        .main-container {
            max-width:1300px; margin:2rem auto; padding:0 2rem;
            display:grid; grid-template-columns:1fr 300px; gap:2rem;
        }
        @media (max-width:900px) { .main-container { grid-template-columns:1fr; } }

        /* ========== FEED COLUMN ========== */
        .feed-column { display:flex; flex-direction:column; gap:1.5rem; }

        /* Create post card */
        .create-post-card {
            background:white; border-radius:24px; padding:1.5rem;
            box-shadow:0 4px 12px rgba(0,0,0,0.03); border:1px solid rgba(0,102,255,0.1);
        }
        .create-post-card textarea {
            width:100%; padding:1rem; border:1px solid #e2e8f0; border-radius:20px;
            font-size:1rem; resize:vertical; margin-bottom:1rem; outline:none;
        }
        .create-post-card textarea:focus { border-color:#0066FF; }
        .post-actions { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; }
        .media-buttons { display:flex; gap:0.5rem; }
        .media-btn {
            background:#f1f5f9; border:none; padding:0.5rem 1.2rem; border-radius:40px;
            font-size:0.9rem; cursor:pointer; display:flex; align-items:center; gap:6px; transition:0.2s;
        }
        .media-btn i { color:#0066FF; }
        .media-btn:hover { background:#e2e8f0; }
        .post-btn {
            background:#FF6B35; color:white; border:none; padding:0.6rem 2rem; border-radius:40px;
            font-weight:600; cursor:pointer; margin-left:auto; transition:background 0.2s;
        }
        .post-btn:disabled { background:#ccc; cursor:not-allowed; }
        .media-preview { margin-top:1rem; display:flex; gap:1rem; flex-wrap:wrap; }
        .preview-item {
            position:relative; width:100px; height:100px; border-radius:16px; overflow:hidden;
            border:1px solid #e2e8f0;
        }
        .preview-item img, .preview-item video { width:100%; height:100%; object-fit:cover; }
        .remove-preview {
            position:absolute; top:4px; right:4px; background:rgba(0,0,0,0.5); color:white;
            border:none; border-radius:50%; width:22px; height:22px; cursor:pointer;
        }
        .video-warning { font-size:0.8rem; color:#64748b; margin-top:0.5rem; }
        .video-warning i { color:#FF6B35; }

        /* Posts feed */
        .post-card {
            background:white; border-radius:24px; padding:1.5rem;
            box-shadow:0 4px 12px rgba(0,0,0,0.03); border:1px solid rgba(0,102,255,0.1);
        }
        .post-header {
            display:flex; align-items:center; gap:1rem; margin-bottom:1rem;
        }
        .post-author-avatar {
            width:44px; height:44px; border-radius:50%; background:#e6f0ff; color:white;
            display:flex; align-items:center; justify-content:center; font-weight:600; font-size:1.1rem;
        }
        .post-author-avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
        .post-author-info h4 { font-size:1rem; }
        .post-author-info span { font-size:0.8rem; color:#64748b; }
        .delete-btn {
            background:none; border:none; color:#d32f2f; cursor:pointer; margin-left:auto;
            font-size:0.9rem; padding:0.2rem 0.8rem; border-radius:40px; transition:0.2s;
        }
        .delete-btn:hover { background:#ffebee; }
        .post-content { margin-bottom:1rem; }
        .post-media { margin:1rem 0; border-radius:16px; overflow:hidden; }
        .post-media img, .post-media video { width:100%; max-height:400px; object-fit:contain; background:#f1f5f9; }
        .post-stats { display:flex; gap:1.5rem; margin-bottom:0.8rem; color:#64748b; font-size:0.9rem; }
        .post-actions-row {
            display:flex; gap:1.5rem; border-top:1px solid #eef2f6; padding-top:0.8rem;
        }
        .action-btn {
            background:none; border:none; display:flex; align-items:center; gap:6px;
            font-size:0.9rem; color:#4b5565; cursor:pointer; transition:color 0.2s;
        }
        .action-btn i { font-size:1.1rem; }
        .action-btn.liked { color:#FF6B35; }
        .action-btn:hover { color:#0066FF; }

        /* Comments */
        .comments-section { margin-top:1rem; background:#f8fafc; border-radius:20px; padding:1rem; }
        .comment { display:flex; gap:0.8rem; margin-bottom:1rem; }
        .comment-avatar {
            width:32px; height:32px; border-radius:50%; background:#e6f0ff; color:white;
            display:flex; align-items:center; justify-content:center; font-weight:600; font-size:0.8rem;
        }
        .comment-content { background:white; padding:0.8rem 1rem; border-radius:18px; flex:1; }
        .comment-content strong { font-size:0.85rem; }
        .comment-content p { margin:0.2rem 0 0; font-size:0.9rem; }
        .comment-time { font-size:0.7rem; color:#94a3b8; margin-top:0.2rem; }
        .add-comment { display:flex; gap:0.5rem; margin-top:0.5rem; }
        .add-comment input {
            flex:1; padding:0.6rem 1rem; border:1px solid #e2e8f0; border-radius:40px;
            font-size:0.9rem; outline:none;
        }
        .add-comment input:focus { border-color:#0066FF; }
        .add-comment button {
            background:#0066FF; color:white; border:none; border-radius:40px;
            padding:0 1.5rem; font-weight:500; cursor:pointer;
        }
        .add-comment button:hover { background:#0052cc; }

        /* Sidebar */
        .sidebar { display:flex; flex-direction:column; gap:1.5rem; }
        .sidebar-card {
            background:white; border-radius:24px; padding:1.5rem;
            box-shadow:0 4px 12px rgba(0,0,0,0.03); border:1px solid rgba(0,102,255,0.1);
        }
        .sidebar-card h3 { margin-bottom:1rem; font-size:1.1rem; }
        .stat-row { display:flex; justify-content:space-between; margin-bottom:0.8rem; }
        .trending-tag {
            background:#f1f5f9; padding:0.4rem 1rem; border-radius:40px; display:inline-block;
            margin:0.2rem; font-size:0.9rem;
        }
        .mentor-card { display:flex; align-items:center; gap:1rem; }
        .mentor-avatar {
            width:48px; height:48px; border-radius:50%; background:#0066FF; color:white;
            display:flex; align-items:center; justify-content:center; font-weight:600;
        }
        .game-teaser {
            background:#f1f5f9; border-radius:40px; padding:0.8rem 1.2rem;
            display:flex; align-items:center; justify-content:space-between;
        }

        /* Black footer */
        .blog-footer {
            background:#000; color:#ccc; padding:3rem 2rem 1.5rem; margin-top:3rem;
        }
        .footer-container {
            max-width:1300px; margin:0 auto; display:grid; grid-template-columns:repeat(3,1fr);
            gap:2rem; text-align:left;
        }
        .footer-col h4 { color:white; margin-bottom:1.2rem; font-size:1.1rem; }
        .footer-col ul { list-style:none; }
        .footer-col li { margin-bottom:0.6rem; }
        .footer-col a { color:#ccc; transition:color 0.2s; }
        .footer-col a:hover { color:#FF6B35; }
        .social-icons { display:flex; gap:1rem; font-size:1.3rem; }
        .social-icons a { color:#ccc; }
        .social-icons a:hover { color:#FF6B35; }
        .copyright {
            text-align:center; margin-top:2rem; padding-top:1.5rem; border-top:1px solid #333;
            color:#777; font-size:0.9rem;
        }
        @media (max-width:700px) { .footer-container { grid-template-columns:1fr; } }
    </style>
</head>
<body>
    <header class="blog-header">
        <div class="header-container">
            <a href="blog-feed.html" class="logo"><i class="fas fa-code"></i> SAMZY<span>blog</span></a>
            <nav class="nav-links">
                <a href="blog-feed.html" class="active">Home</a>
                <a href="blog-profile.html">Profile</a>
                <a href="blog-leaderboard.html">Leaderboard</a>
                <a href="blog-games.html">Games</a>
            </nav>
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar"><span id="avatarText"></span></div>
                <div class="dropdown" id="dropdown">
                    <a href="blog-profile.html"><i class="fas fa-user"></i> Profile</a>
                    <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Feed Column -->
        <div class="feed-column">
            <!-- Create Post Card -->
            <div class="create-post-card" id="createPostSection">
                <textarea id="postContent" placeholder="What's on your mind?" rows="3"></textarea>
                <div class="post-actions">
                    <div class="media-buttons">
                        <button class="media-btn" id="imageUploadBtn"><i class="fas fa-image"></i> Image</button>
                        <button class="media-btn" id="videoUploadBtn"><i class="fas fa-video"></i> Video</button>
                    </div>
                    <button class="post-btn" id="submitPost">Post</button>
                </div>
                <input type="file" id="imageInput" accept="image/*" style="display:none;">
                <input type="file" id="videoInput" accept="video/*" style="display:none;">
                <div class="media-preview" id="mediaPreview"></div>
                <div class="video-warning" id="videoWarning" style="display:none;"><i class="fas fa-info-circle"></i> Videos are automatically deleted after 7 days.</div>
            </div>

            <!-- Posts Feed -->
            <div id="postsFeed"></div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-card">
                <h3>Quick Stats</h3>
                <div class="stat-row"><span>Total members:</span> <strong id="totalMembers">0</strong></div>
                <div class="stat-row"><span>Posts today:</span> <strong id="postsToday">0</strong></div>
            </div>
            <div class="sidebar-card">
                <h3>Trending Topics</h3>
                <div><span class="trending-tag">#webdev</span><span class="trending-tag">#career</span><span class="trending-tag">#mentorship</span></div>
            </div>
            <div class="sidebar-card">
                <h3>Promoted Mentor</h3>
                <div class="mentor-card"><div class="mentor-avatar">MK</div><div><strong>Mary K.</strong><p style="font-size:0.9rem;">Senior Developer</p></div></div>
                <p>"Keep learning, keep growing."</p>
            </div>
            <div class="sidebar-card">
                <h3>Play & Earn</h3>
                <div class="game-teaser"><span>Earn points by playing games!</span><a href="blog-games.html" style="background:#FF6B35; color:white; padding:0.3rem 1rem; border-radius:40px;">Go</a></div>
            </div>
        </aside>
    </div>

    <footer class="blog-footer">
        <div class="footer-container">
            <div class="footer-col"><h4>Navigation</h4><ul><li><a href="blog-feed.html">Home</a></li><li><a href="blog-profile.html">Profile</a></li><li><a href="blog-leaderboard.html">Leaderboard</a></li><li><a href="blog-games.html">Games</a></li></ul></div>
            <div class="footer-col"><h4>Legal</h4><ul><li><a href="terms.html">Terms of Service</a></li><li><a href="privacy.html">Privacy Policy</a></li><li><a href="cookies.html">Cookie Policy</a></li></ul></div>
            <div class="footer-col"><h4>Connect</h4><div class="social-icons"><a href="#"><i class="fab fa-twitter"></i></a><a href="#"><i class="fab fa-linkedin"></i></a><a href="#"><i class="fab fa-github"></i></a></div></div>
        </div>
        <div class="copyright">© 2026 Samzy Digital Community. All rights reserved.</div>
    </footer>

    <!-- Firebase SDK (still needed for Auth and Firestore) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <!-- No Firebase Storage needed now -->

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBkgwVFe1PMYMvmZxoFVFErZ27Q3XYQ-_g",
            authDomain: "samzy-community-blog.firebaseapp.com",
            projectId: "samzy-community-blog",
            storageBucket: "samzy-community-blog.firebasestorage.app",
            messagingSenderId: "573240466296",
            appId: "1:573240466296:web:5faa312a1136162961468d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        // Storage not used anymore

        let currentUser = null;

        auth.onAuthStateChanged(user => {
            if (!user) { window.location.href = 'login.html'; return; }
            currentUser = user;
            loadUserAvatar(user);
            loadPosts();
            loadStats();
        });

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${hash % 360}, 70%, 80%)`;
        }

        function loadUserAvatar(user) {
            const avatarDiv = document.querySelector('.user-avatar');
            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists && doc.data().avatarURL) {
                    avatarDiv.innerHTML = `<img src="${doc.data().avatarURL}" alt="avatar">`;
                } else {
                    const displayName = doc.exists && doc.data().displayName ? doc.data().displayName : user.email;
                    const initials = displayName.charAt(0).toUpperCase();
                    avatarDiv.style.background = stringToColor(displayName);
                    avatarDiv.innerHTML = `<span>${initials}</span>`;
                }
            }).catch(() => {
                avatarDiv.style.background = stringToColor(user.email);
                avatarDiv.innerHTML = `<span>${user.email.charAt(0).toUpperCase()}</span>`;
            });
        }

        document.getElementById('userAvatar').addEventListener('click', e => {
            e.stopPropagation();
            document.getElementById('dropdown').classList.toggle('show');
        });
        document.addEventListener('click', () => document.getElementById('dropdown').classList.remove('show'));

        document.getElementById('logoutBtn').addEventListener('click', e => {
            e.preventDefault();
            auth.signOut().then(() => window.location.href = 'community.html');
        });

        // ---------- Media selection and preview ----------
        let selectedImageFile = null;
        let selectedVideoFile = null;
        const imageInput = document.getElementById('imageInput');
        const videoInput = document.getElementById('videoInput');
        const mediaPreview = document.getElementById('mediaPreview');
        const videoWarning = document.getElementById('videoWarning');

        document.getElementById('imageUploadBtn').addEventListener('click', () => imageInput.click());
        document.getElementById('videoUploadBtn').addEventListener('click', () => videoInput.click());

        imageInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                selectedImageFile = file;
                selectedVideoFile = null;
                showPreview(file, 'image');
                videoInput.value = '';
                videoWarning.style.display = 'none';
            }
        });

        videoInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                // Check duration client-side
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = () => {
                    if (video.duration > 30) {
                        alert('Video must be 30 seconds or less.');
                        videoInput.value = '';
                        return;
                    }
                    selectedVideoFile = file;
                    selectedImageFile = null;
                    showPreview(file, 'video');
                    imageInput.value = '';
                    videoWarning.style.display = 'block';
                };
                video.src = URL.createObjectURL(file);
            }
        });

        function showPreview(file, type) {
            const reader = new FileReader();
            reader.onload = e => {
                mediaPreview.innerHTML = `
                    <div class="preview-item">
                        ${type === 'image' ? `<img src="${e.target.result}">` : `<video src="${e.target.result}"></video>`}
                        <button class="remove-preview" onclick="clearMedia()"><i class="fas fa-times"></i></button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }
        window.clearMedia = function() {
            selectedImageFile = null;
            selectedVideoFile = null;
            mediaPreview.innerHTML = '';
            imageInput.value = '';
            videoInput.value = '';
            videoWarning.style.display = 'none';
        };

        // ---------- Cloudinary upload function ----------
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'samzy-community-blog'); // your unsigned preset

            const response = await fetch('https://api.cloudinary.com/v1_1/djy2jtwmw/upload', {
                method: 'POST',
                body: formData
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Cloudinary upload failed: ${errorText}`);
            }
            const data = await response.json();
            return data.secure_url; // returns the public URL
        }

        // ---------- Submit post ----------
        document.getElementById('submitPost').addEventListener('click', async () => {
            const content = document.getElementById('postContent').value.trim();
            if (!content && !selectedImageFile && !selectedVideoFile) {
                alert('Please write something or attach media.');
                return;
            }
            const btn = document.getElementById('submitPost');
            btn.disabled = true;
            btn.textContent = 'Uploading...';

            try {
                let mediaURL = null, mediaType = null;
                if (selectedImageFile) {
                    mediaType = 'image';
                    mediaURL = await uploadToCloudinary(selectedImageFile);
                } else if (selectedVideoFile) {
                    mediaType = 'video';
                    mediaURL = await uploadToCloudinary(selectedVideoFile);
                }

                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const displayName = userDoc.exists && userDoc.data().displayName ? userDoc.data().displayName : currentUser.email;

                await db.collection('posts').add({
                    authorId: currentUser.uid,
                    authorName: displayName,
                    text: content,
                    mediaURL,
                    mediaType,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    likeCount: 0,
                    commentCount: 0
                });

                document.getElementById('postContent').value = '';
                clearMedia();
                btn.disabled = false;
                btn.textContent = 'Post';
                alert('Posted!');
            } catch (error) {
                console.error('Error:', error);
                alert('Error posting: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Post';
            }
        });

        // ---------- Load posts (real-time) ----------
        function loadPosts() {
            db.collection('posts').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                const feed = document.getElementById('postsFeed');
                feed.innerHTML = '';
                snapshot.forEach(doc => feed.appendChild(createPostElement(doc.data(), doc.id)));
            });
        }

        function createPostElement(post, id) {
            const card = document.createElement('div');
            card.className = 'post-card';
            card.dataset.postId = id;

            const date = post.createdAt ? post.createdAt.toDate() : new Date();
            const timeAgo = formatTimeAgo(date);
            const authorName = post.authorName || 'Anonymous';
            const authorInitial = authorName.charAt(0).toUpperCase();
            const avatarColor = stringToColor(authorName);

            let mediaHTML = '';
            if (post.mediaURL && post.mediaType) {
                if (post.mediaType === 'image') {
                    mediaHTML = `<div class="post-media"><img src="${post.mediaURL}" alt="post image"></div>`;
                } else if (post.mediaType === 'video') {
                    mediaHTML = `<div class="post-media"><video src="${post.mediaURL}" controls></video></div>`;
                }
            }

            const deleteButton = (currentUser && post.authorId === currentUser.uid)
                ? `<button class="delete-btn" onclick="deletePost('${id}', '${post.mediaURL || ''}')"><i class="fas fa-trash"></i> Delete</button>`
                : '';

            const commentsHTML = `
                <div class="comments-section" id="comments-${id}" style="display:none;">
                    <div id="comments-list-${id}"></div>
                    <div class="add-comment">
                        <input type="text" id="comment-input-${id}" placeholder="Write a comment...">
                        <button onclick="addComment('${id}')">Post</button>
                    </div>
                </div>
            `;

            card.innerHTML = `
                <div class="post-header">
                    <div class="post-author-avatar" style="background:${avatarColor};"><span>${authorInitial}</span></div>
                    <div class="post-author-info">
                        <h4>${authorName}</h4>
                        <span>${timeAgo}</span>
                    </div>
                    ${deleteButton}
                </div>
                <div class="post-content">${post.text || ''}</div>
                ${mediaHTML}
                <div class="post-stats">
                    <span><i class="fas fa-heart"></i> ${post.likeCount || 0}</span>
                    <span><i class="fas fa-comment"></i> ${post.commentCount || 0}</span>
                </div>
                <div class="post-actions-row">
                    <button class="action-btn" onclick="toggleLike('${id}')"><i class="fas fa-heart"></i> Like</button>
                    <button class="action-btn" onclick="toggleComments('${id}')"><i class="fas fa-comment"></i> Comment</button>
                </div>
                ${commentsHTML}
            `;
            loadComments(id);
            return card;
        }

        // ---------- Delete post (still works with Cloudinary URL – we don't delete from Cloudinary automatically) ----------
        window.deletePost = async function(postId, mediaURL) {
            if (!currentUser) return;
            if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) return;
            try {
                // Note: We are NOT deleting the file from Cloudinary here (Cloudinary would require its own API).
                // You can later add Cloudinary deletion using their API if needed.
                await db.collection('posts').doc(postId).delete();
                console.log('Post deleted');
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete post.');
            }
        };

        // ---------- Like toggle ----------
        window.toggleLike = async (postId) => {
            if (!currentUser) return;
            const likeRef = db.collection('posts').doc(postId).collection('likes').doc(currentUser.uid);
            const postRef = db.collection('posts').doc(postId);
            const likeDoc = await likeRef.get();
            if (likeDoc.exists) {
                await likeRef.delete();
                await postRef.update({ likeCount: firebase.firestore.FieldValue.increment(-1) });
            } else {
                await likeRef.set({ userId: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                await postRef.update({ likeCount: firebase.firestore.FieldValue.increment(1) });
                const post = await postRef.get();
                if (post.data().authorId !== currentUser.uid) {
                    await db.collection('notifications').add({
                        recipientId: post.data().authorId,
                        type: 'like',
                        fromUserId: currentUser.uid,
                        fromUserName: currentUser.displayName || 'Someone',
                        postId,
                        read: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }
        };

        // ---------- Comments ----------
        window.toggleComments = (postId) => {
            const div = document.getElementById(`comments-${postId}`);
            if (div) div.style.display = div.style.display === 'none' ? 'block' : 'none';
        };

        window.addComment = async (postId) => {
            if (!currentUser) return;
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if (!text) return;
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const displayName = userDoc.exists && userDoc.data().displayName ? userDoc.data().displayName : currentUser.email;
            await db.collection('posts').doc(postId).collection('comments').add({
                authorId: currentUser.uid,
                authorName: displayName,
                text,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection('posts').doc(postId).update({ commentCount: firebase.firestore.FieldValue.increment(1) });
            const post = await db.collection('posts').doc(postId).get();
            if (post.data().authorId !== currentUser.uid) {
                await db.collection('notifications').add({
                    recipientId: post.data().authorId,
                    type: 'comment',
                    fromUserId: currentUser.uid,
                    fromUserName: displayName,
                    postId,
                    read: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            input.value = '';
        };

        function loadComments(postId) {
            db.collection('posts').doc(postId).collection('comments').orderBy('createdAt', 'asc').onSnapshot(snapshot => {
                const list = document.getElementById(`comments-list-${postId}`);
                if (!list) return;
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const date = c.createdAt ? c.createdAt.toDate() : new Date();
                    const timeAgo = formatTimeAgo(date);
                    const commentAuthor = c.authorName || 'Anonymous';
                    const commentInitial = commentAuthor.charAt(0).toUpperCase();
                    const avatarColor = stringToColor(commentAuthor);
                    list.innerHTML += `
                        <div class="comment">
                            <div class="comment-avatar" style="background:${avatarColor};"><span>${commentInitial}</span></div>
                            <div class="comment-content">
                                <strong>${commentAuthor}</strong>
                                <p>${c.text}</p>
                                <div class="comment-time">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // ---------- Stats ----------
        async function loadStats() {
            try {
                const usersSnap = await db.collection('users').count().get();
                document.getElementById('totalMembers').textContent = usersSnap.data().count;
                const today = new Date(); today.setHours(0,0,0,0);
                const postsSnap = await db.collection('posts').where('createdAt', '>=', today).count().get();
                document.getElementById('postsToday').textContent = postsSnap.data().count;
            } catch (e) { console.error('Stats error:', e); }
        }

        function formatTimeAgo(date) {
            const s = Math.floor((new Date() - date)/1000);
            if (s < 60) return 'just now';
            if (s < 3600) return Math.floor(s/60)+'m ago';
            if (s < 86400) return Math.floor(s/3600)+'h ago';
            return Math.floor(s/86400)+'d ago';
        }
    </script>
</body>
</html>