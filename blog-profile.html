<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile ¬∑ Samzy Community</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ========== GLOBAL STYLES (same as feed) ========== */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
        body { background:#f8fafc; color:#1e293b; }
        a { text-decoration:none; color:inherit; }
        .blog-header {
            background:white; position:sticky; top:0; z-index:50;
            box-shadow:0 2px 10px rgba(0,0,0,0.03);
            border-bottom:1px solid rgba(0,102,255,0.1);
        }
        .header-container {
            max-width:1300px; margin:0 auto; padding:1rem 2rem;
            display:flex; align-items:center; justify-content:space-between;
        }
        .logo { font-size:1.5rem; font-weight:600; }
        .logo i { color:#0066FF; margin-right:6px; }
        .logo span { color:#FF6B35; }
        .nav-links { display:flex; gap:2rem; }
        .nav-links a { font-weight:500; padding:0.5rem 0; border-bottom:2px solid transparent; transition:0.2s; }
        .nav-links a:hover, .nav-links a.active { color:#0066FF; border-bottom-color:#0066FF; }
        .user-menu { position:relative; }
        .user-avatar {
            width:40px; height:40px; border-radius:50%; background:#e6f0ff; color:#0066FF;
            display:flex; align-items:center; justify-content:center; font-weight:600; cursor:pointer;
        }
        .user-avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
        .dropdown {
            position:absolute; right:0; top:50px; background:white; border-radius:16px;
            box-shadow:0 10px 30px rgba(0,0,0,0.1); width:180px; display:none; z-index:100;
            border:1px solid #eef2f6;
        }
        .dropdown.show { display:block; }
        .dropdown a { display:flex; align-items:center; gap:10px; padding:0.9rem 1.2rem; transition:background 0.2s; }
        .dropdown a:hover { background:#f1f5f9; }
        .dropdown i { width:20px; color:#0066FF; }
        .main-container {
            max-width:1000px; margin:2rem auto; padding:0 2rem;
        }
        .profile-card {
            background:white; border-radius:24px; padding:2rem;
            box-shadow:0 4px 12px rgba(0,0,0,0.03); border:1px solid rgba(0,102,255,0.1);
            display:flex; gap:2rem; flex-wrap:wrap; align-items:center; margin-bottom:2rem;
        }
        .profile-avatar {
            width:100px; height:100px; border-radius:50%; background:#e6f0ff;
            display:flex; align-items:center; justify-content:center;
            font-size:2.5rem; font-weight:600; color:#0066FF;
            position:relative;
        }
        .profile-avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
        .profile-info { flex:1; }
        .profile-info h2 { font-size:2rem; margin-bottom:0.2rem; }
        .profile-info .email { color:#64748b; margin-bottom:0.5rem; }
        .profile-info .badge {
            background:#f1f5f9; padding:0.3rem 1rem; border-radius:40px; font-size:0.9rem;
            display:inline-block; margin-right:0.5rem; margin-bottom:0.5rem;
        }
        .profile-stats {
            display:flex; gap:2rem; margin-top:1rem; flex-wrap:wrap;
        }
        .stat-item { text-align:center; }
        .stat-value { font-size:1.5rem; font-weight:600; color:#0066FF; }
        .stat-label { font-size:0.9rem; color:#64748b; }
        .edit-btn {
            background:#FF6B35; color:white; border:none; padding:0.5rem 1.5rem;
            border-radius:40px; cursor:pointer; font-weight:500; margin-left:auto;
        }
        .edit-modal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;
        }
        .modal-content {
            background:white; border-radius:24px; padding:2rem; max-width:400px; width:90%;
        }
        .modal-content h3 { margin-bottom:1rem; }
        .modal-content input[type="file"] { margin:1rem 0; }
        .modal-content input[type="text"] {
            width:100%; padding:0.8rem; border:1px solid #e2e8f0; border-radius:40px;
            margin:0.5rem 0; font-size:1rem;
        }
        .modal-actions { display:flex; gap:1rem; margin-top:1.5rem; }
        .save-btn {
            background:#0066FF; color:white; border:none; padding:0.8rem; border-radius:40px;
            flex:1; font-weight:600; cursor:pointer;
        }
        .cancel-btn {
            background:#f1f5f9; color:#1e293b; border:none; padding:0.8rem; border-radius:40px;
            flex:1; font-weight:600; cursor:pointer;
        }
        .disabled-field { background:#f1f5f9; color:#64748b; cursor:not-allowed; }
        .section-title { font-size:1.3rem; margin:2rem 0 1rem; }
        .notification-list, .recent-posts-list { list-style:none; }
        .notification-item, .recent-post-item {
            background:white; border-radius:16px; padding:1rem; margin-bottom:0.8rem;
            border:1px solid rgba(0,102,255,0.1); display:flex; align-items:center; gap:1rem;
        }
        .notification-icon {
            width:40px; height:40px; border-radius:50%; background:#f1f5f9;
            display:flex; align-items:center; justify-content:center; color:#0066FF;
        }
        .notification-content { flex:1; }
        .notification-time { font-size:0.8rem; color:#94a3b8; }
        .recent-post-link { color:#0066FF; font-weight:500; margin-left:auto; }
        .empty-message { color:#94a3b8; text-align:center; padding:2rem; }
        .error-message { color:#d32f2f; background:#ffebee; padding:1rem; border-radius:16px; text-align:center; margin:2rem 0; }
        .info-message { color:#0066FF; background:#e6f0ff; padding:1rem; border-radius:16px; text-align:center; margin:2rem 0; }
        .blog-footer {
            background:#000; color:#ccc; padding:3rem 2rem 1.5rem; margin-top:3rem;
        }
        .footer-container {
            max-width:1300px; margin:0 auto; display:grid; grid-template-columns:repeat(3,1fr);
            gap:2rem; text-align:left;
        }
        .footer-col h4 { color:white; margin-bottom:1.2rem; font-size:1.1rem; }
        .footer-col ul { list-style:none; }
        .footer-col li { margin-bottom:0.6rem; }
        .footer-col a { color:#ccc; transition:color 0.2s; }
        .footer-col a:hover { color:#FF6B35; }
        .social-icons { display:flex; gap:1rem; font-size:1.3rem; }
        .social-icons a { color:#ccc; }
        .social-icons a:hover { color:#FF6B35; }
        .copyright {
            text-align:center; margin-top:2rem; padding-top:1.5rem; border-top:1px solid #333;
            color:#777; font-size:0.9rem;
        }
        @media (max-width:700px) { .footer-container { grid-template-columns:1fr; } }
    </style>
</head>
<body>
    <header class="blog-header">
        <div class="header-container">
            <a href="blog-feed.html" class="logo"><i class="fas fa-code"></i> SAMZY<span>blog</span></a>
            <nav class="nav-links">
                <a href="blog-feed.html">Home</a>
                <a href="blog-profile.html" class="active">Profile</a>
                <a href="blog-leaderboard.html">Leaderboard</a>
                <a href="blog-games.html">Games</a>
            </nav>
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar"><span id="avatarText"></span></div>
                <div class="dropdown" id="dropdown">
                    <a href="blog-profile.html"><i class="fas fa-user"></i> Profile</a>
                    <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container" id="profileContainer">
        <div class="empty-message">Loading profile...</div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editModal" class="edit-modal">
        <div class="modal-content">
            <h3>Edit Profile</h3>
            <label for="avatarUpload">Profile Picture</label>
            <input type="file" id="avatarUpload" accept="image/*">
            <div style="margin:0.5rem 0; font-size:0.9rem; color:#64748b;">Max 2MB</div>
            
            <label for="displayNameInput">Display Name (can only be set once)</label>
            <input type="text" id="displayNameInput" placeholder="Your name">
            
            <div class="modal-actions">
                <button class="save-btn" id="saveProfileBtn">Save</button>
                <button class="cancel-btn" id="cancelEditBtn">Cancel</button>
            </div>
        </div>
    </div>

    <footer class="blog-footer">
        <div class="footer-container">
            <div class="footer-col"><h4>Navigation</h4><ul><li><a href="blog-feed.html">Home</a></li><li><a href="blog-profile.html">Profile</a></li><li><a href="blog-leaderboard.html">Leaderboard</a></li><li><a href="blog-games.html">Games</a></li></ul></div>
            <div class="footer-col"><h4>Legal</h4><ul><li><a href="terms.html">Terms of Service</a></li><li><a href="privacy.html">Privacy Policy</a></li><li><a href="cookies.html">Cookie Policy</a></li></ul></div>
            <div class="footer-col"><h4>Connect</h4><div class="social-icons"><a href="#"><i class="fab fa-twitter"></i></a><a href="#"><i class="fab fa-linkedin"></i></a><a href="#"><i class="fab fa-github"></i></a></div></div>
        </div>
        <div class="copyright">¬© 2026 Samzy Digital Community. All rights reserved.</div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBkgwVFe1PMYMvmZxoFVFErZ27Q3XYQ-_g",
            authDomain: "samzy-community-blog.firebaseapp.com",
            projectId: "samzy-community-blog",
            storageBucket: "samzy-community-blog.firebasestorage.app",
            messagingSenderId: "573240466296",
            appId: "1:573240466296:web:5faa312a1136162961468d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userData = null;
        let nameChangeAllowed = true;

        auth.onAuthStateChanged(async user => {
            if (!user) { window.location.href = 'login.html'; return; }
            currentUser = user;
            loadUserAvatar(user);
            try {
                await loadProfile(user);
                await loadNotifications(user);
                await loadAllPosts(user);
            } catch (error) {
                console.error('Fatal error loading profile:', error);
                document.getElementById('profileContainer').innerHTML = `<div class="error-message">Failed to load profile: ${error.message}. Check console.</div>`;
            }
        });

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${hash % 360}, 70%, 80%)`;
        }

        function loadUserAvatar(user) {
            const avatarDiv = document.querySelector('.user-avatar');
            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists && doc.data().avatarURL) {
                    avatarDiv.innerHTML = `<img src="${doc.data().avatarURL}" alt="avatar">`;
                } else {
                    const displayName = doc.exists && doc.data().displayName ? doc.data().displayName : user.email;
                    const initials = displayName.charAt(0).toUpperCase();
                    avatarDiv.style.background = stringToColor(displayName);
                    avatarDiv.innerHTML = `<span>${initials}</span>`;
                }
            }).catch(() => {
                avatarDiv.style.background = stringToColor(user.email);
                avatarDiv.innerHTML = `<span>${user.email.charAt(0).toUpperCase()}</span>`;
            });
        }

        document.getElementById('userAvatar').addEventListener('click', e => {
            e.stopPropagation();
            document.getElementById('dropdown').classList.toggle('show');
        });
        document.addEventListener('click', () => document.getElementById('dropdown').classList.remove('show'));

        document.getElementById('logoutBtn').addEventListener('click', e => {
            e.preventDefault();
            auth.signOut().then(() => window.location.href = 'community.html');
        });

        async function loadProfile(user) {
            const container = document.getElementById('profileContainer');
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (!userDoc.exists) {
                console.warn('User document missing, creating default...');
                await db.collection('users').doc(user.uid).set({
                    email: user.email,
                    displayName: user.email,
                    points: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    experience: 'beginner',
                    interests: []
                });
                userData = (await db.collection('users').doc(user.uid).get()).data();
            } else {
                userData = userDoc.data();
            }
            let displayName = userData.displayName || user.email;
            let experience = userData.experience || 'beginner';
            let interests = Array.isArray(userData.interests) ? userData.interests : [];
            let points = userData.points || 0;
            let createdAt = userData.createdAt ? userData.createdAt.toDate() : new Date();
            let avatarURL = userData.avatarURL || null;
            nameChangeAllowed = !userData.nameChanged;

            // Get posts for stats (simple query without orderBy, to avoid index issues for count)
            const postsSnap = await db.collection('posts').where('authorId', '==', user.uid).get();
            const postCount = postsSnap.size;

            let likesReceived = 0;
            postsSnap.forEach(doc => { likesReceived += (doc.data().likeCount || 0); });

            let commentsReceived = 0;
            for (const doc of postsSnap.docs) {
                const commentSnap = await db.collection('posts').doc(doc.id).collection('comments').get();
                commentsReceived += commentSnap.size;
            }

            const joinDate = createdAt.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });

            let avatarHTML = avatarURL
                ? `<img src="${avatarURL}" alt="avatar">`
                : `<span>${displayName.charAt(0).toUpperCase()}</span>`;

            container.innerHTML = `
                <div class="profile-card">
                    <div class="profile-avatar" style="background:${stringToColor(displayName)};">
                        ${avatarHTML}
                    </div>
                    <div class="profile-info">
                        <h2>${displayName}</h2>
                        <div class="email">${user.email}</div>
                        <div><span class="badge">${experience}</span>${interests.map(i => `<span class="badge">${i}</span>`).join('')}</div>
                        <div class="profile-stats">
                            <div class="stat-item"><div class="stat-value">${postCount}</div><div class="stat-label">Posts</div></div>
                            <div class="stat-item"><div class="stat-value">${likesReceived}</div><div class="stat-label">Likes</div></div>
                            <div class="stat-item"><div class="stat-value">${commentsReceived}</div><div class="stat-label">Comments</div></div>
                            <div class="stat-item"><div class="stat-value">${points}</div><div class="stat-label">Points</div></div>
                        </div>
                        <div style="margin-top:0.8rem; color:#64748b;"><i class="fas fa-calendar-alt"></i> Joined ${joinDate}</div>
                    </div>
                    <button class="edit-btn" id="openEditModal"><i class="fas fa-edit"></i> Edit Profile</button>
                </div>
                <h3 class="section-title"><i class="fas fa-bell"></i> Recent Notifications</h3>
                <div class="notification-list" id="notificationList"><div class="empty-message">Loading...</div></div>
                <h3 class="section-title"><i class="fas fa-file-alt"></i> All Your Posts</h3>
                <div class="recent-posts-list" id="postsList"><div class="empty-message">Loading...</div></div>
            `;

            document.getElementById('openEditModal').addEventListener('click', () => openEditModal(displayName, nameChangeAllowed));
        }

        // Modal elements
        const modal = document.getElementById('editModal');
        const nameInput = document.getElementById('displayNameInput');
        const avatarInput = document.getElementById('avatarUpload');

        function openEditModal(currentName, nameAllowed) {
            nameInput.value = currentName;
            nameInput.disabled = !nameAllowed;
            nameInput.classList.toggle('disabled-field', !nameAllowed);
            modal.style.display = 'flex';
        }

        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // Cloudinary upload function (same as feed)
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'samzy-community-blog'); // your unsigned preset

            const response = await fetch('https://api.cloudinary.com/v1_1/djy2jtwmw/upload', {
                method: 'POST',
                body: formData
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Cloudinary upload failed: ${errorText}`);
            }
            const data = await response.json();
            return data.secure_url;
        }

        document.getElementById('saveProfileBtn').addEventListener('click', async () => {
            const newName = nameInput.value.trim();
            const file = avatarInput.files[0];
            if (file && file.size > 2 * 1024 * 1024) {
                alert('Image must be less than 2MB.');
                return;
            }
            if (!newName && !file) {
                modal.style.display = 'none';
                return;
            }

            const saveBtn = document.getElementById('saveProfileBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;

            try {
                let avatarURL = null;
                if (file) {
                    avatarURL = await uploadToCloudinary(file);
                }

                const updateData = {};
                if (avatarURL) updateData.avatarURL = avatarURL;
                if (newName && nameChangeAllowed) {
                    updateData.displayName = newName;
                    updateData.nameChanged = true;
                }

                if (Object.keys(updateData).length > 0) {
                    const userRef = db.collection('users').doc(currentUser.uid);
                    await userRef.update(updateData);
                }

                // Refresh profile and header
                await loadProfile(currentUser);
                loadUserAvatar(currentUser);
                modal.style.display = 'none';
                alert('Profile updated successfully!');
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Failed to update profile: ' + error.message);
            } finally {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                avatarInput.value = '';
            }
        });

        async function loadNotifications(user) {
            const list = document.getElementById('notificationList');
            if (!list) return;
            try {
                let snapshot;
                try {
                    snapshot = await db.collection('notifications')
                        .where('recipientId', '==', user.uid)
                        .orderBy('createdAt', 'desc')
                        .limit(10)
                        .get();
                } catch (queryError) {
                    if (queryError.code === 'failed-precondition' || queryError.message.includes('index')) {
                        list.innerHTML = `<div class="info-message">
                            <i class="fas fa-info-circle"></i> Notifications require a database index. 
                            Please check the browser console for the link to create it.
                        </div>`;
                        return;
                    } else throw queryError;
                }
                if (snapshot.empty) {
                    list.innerHTML = '<div class="empty-message">No notifications yet.</div>';
                    return;
                }
                let html = '';
                snapshot.forEach(doc => {
                    const n = doc.data();
                    const date = n.createdAt ? n.createdAt.toDate() : new Date();
                    const timeAgo = formatTimeAgo(date);
                    const icon = n.type === 'like' ? '‚ù§Ô∏è' : 'üí¨';
                    html += `
                        <div class="notification-item">
                            <div class="notification-icon">${icon}</div>
                            <div class="notification-content">
                                <strong>${n.fromUserName || 'Someone'}</strong> ${n.type === 'like' ? 'liked your post.' : 'commented on your post.'}
                                <div class="notification-time">${timeAgo}</div>
                            </div>
                            <a href="blog-feed.html?post=${n.postId}" class="recent-post-link">View</a>
                        </div>
                    `;
                });
                list.innerHTML = html;
            } catch (e) {
                console.error('Notifications error:', e);
                list.innerHTML = '<div class="error-message">Could not load notifications.</div>';
            }
        }

        async function loadAllPosts(user) {
            const list = document.getElementById('postsList');
            if (!list) return;
            try {
                // Try to fetch posts ordered by date (requires index)
                let snapshot;
                try {
                    snapshot = await db.collection('posts')
                        .where('authorId', '==', user.uid)
                        .orderBy('createdAt', 'desc')
                        .get();
                } catch (queryError) {
                    if (queryError.code === 'failed-precondition' || queryError.message.includes('index')) {
                        list.innerHTML = `<div class="info-message">
                            <i class="fas fa-info-circle"></i> To see your posts, you need to create a database index. 
                            <a href="https://console.firebase.google.com/v1/r/project/samzy-community-blog/firestore/indexes" target="_blank" style="color:#0066FF; text-decoration:underline;">Click here</a> to go to the Firebase Console and create an index with:
                            <br><strong>Collection:</strong> posts
                            <br><strong>Fields:</strong> authorId (Ascending), createdAt (Descending)
                            <br>After creating the index, please refresh this page.
                        </div>`;
                        return;
                    } else {
                        throw queryError;
                    }
                }

                if (snapshot.empty) {
                    list.innerHTML = '<div class="empty-message">You haven‚Äôt posted yet.</div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const date = p.createdAt ? p.createdAt.toDate() : new Date();
                    const timeAgo = formatTimeAgo(date);
                    const preview = p.text ? p.text.substring(0,60)+(p.text.length>60?'‚Ä¶':'') : '(no text)';
                    html += `
                        <div class="recent-post-item">
                            <div><i class="fas fa-file-alt" style="color:#0066FF;"></i></div>
                            <div class="notification-content">
                                <strong>${preview}</strong>
                                <div class="notification-time">${timeAgo} ¬∑ ‚ù§Ô∏è ${p.likeCount||0} ¬∑ üí¨ ${p.commentCount||0}</div>
                            </div>
                            <a href="blog-feed.html?post=${doc.id}" class="recent-post-link">View</a>
                        </div>
                    `;
                });
                list.innerHTML = html;
            } catch (e) {
                console.error('Posts error:', e);
                list.innerHTML = '<div class="error-message">Could not load posts. Check console for details.</div>';
            }
        }

        function formatTimeAgo(date) {
            const s = Math.floor((new Date() - date)/1000);
            if (s < 60) return 'just now';
            if (s < 3600) return Math.floor(s/60)+'m ago';
            if (s < 86400) return Math.floor(s/3600)+'h ago';
            return Math.floor(s/86400)+'d ago';
        }
    </script>
</body>
</html>